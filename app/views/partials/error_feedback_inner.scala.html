@*
 * Copyright 2021 HM Revenue & Customs
 *
 *@

@import util.GetHelpWithThisPageFeatureFieldHints
@import util.GetHelpWithThisPageNewLargeInputFields
@import util.GetHelpWithThisPageImprovedFieldValidation
@import util.GetHelpWithThisPageOnlyServerSideValidation
@import config.AppConfig
@import uk.gov.hmrc.play.views.html._
@import uk.gov.hmrc.play.views.html.helpers._
@import views.html.helpers._
@import views.helpers.ServiceParameter.extractServiceParameter

@this()

@(problemReportForm : Form[model.ProblemReport], actionUrl: String, csrfToken: Option[String], service : Option[String], referrer : Option[String])(implicit request : Request[_], lang : Lang, messages : Messages, appConfig : AppConfig)

@improvedNameFieldValidation = @{appConfig.hasFeature(GetHelpWithThisPageImprovedFieldValidation, service)}
@clientSideValidation = @{ !appConfig.hasFeature(GetHelpWithThisPageOnlyServerSideValidation, service) }

<h2>@messages("common.feedback.title")</h2>
<p>@messages("common.feedback.only_use_form")</p>
<p>@messages("common.feedback.information.warning")</p>

<form action="@actionUrl" method="POST" id="error-feedback-form" class="form--feedback" novalidate>
    @if(csrfToken.isDefined) {
    <input type="hidden" name="csrfToken" value="@{csrfToken.get}"/>
    }

    <input type="hidden" name="service" id="service" value="@extractServiceParameter(problemReportForm, None)"/>

    @if(appConfig.hasFeature(GetHelpWithThisPageNewLargeInputFields, service)) {

        <div id="largeInputFields" class="js-visible">

            @error_feedback_input(
            problemReportForm("report-name"),
            _label = Some(messages("form.name")),
            _divClass = Some("form-field"),
            _inputClass = Some("input--medium"),
            _id = Some("report-name-new"),
            _maxlength = Some(70),
            _dataProperties = Map(
                "data-rule-pattern"-> {
                    if (improvedNameFieldValidation) {
                        controllers.ProblemReportForm.REPORT_NAME_REGEX
                    } else {
                        controllers.ProblemReportForm.OLD_REPORT_NAME_REGEX
                    }
                },
                "data-msg-pattern" -> {
                    if (improvedNameFieldValidation) {
                        messages("error.common.problem_report.name_valid.b")
                    } else {
                        messages("error.common.problem_report.name_valid")
                    }
                },
                "data-rule-required" -> "true",
                "data-msg-required" -> messages("error.common.problem_report.name_mandatory.b")
            ),
            _clientSideValidation = clientSideValidation
            )

            @error_feedback_input(
            problemReportForm("report-email"),
            _label = Some(messages("problem_report.email.b")),
            _divClass = Some("form-field"),
            _inputClass = Some("input--medium"),
            _id = Some("report-email-new"),
            _maxlength = Some(255),
            _dataProperties = Map(
                "data-rule-email" -> "true",
                "data-msg-email" -> messages("error.common.problem_report.email_valid"),
                "data-rule-required" -> "true",
                "data-msg-required" -> messages("error.common.problem_report.email_mandatory.b")
            ),
            _clientSideValidation = clientSideValidation
            )

            @error_feedback_textarea(
            problemReportForm("report-action"),
            _label = Some(messages("problem_report.action.b")),
            _divClass = Some("form-field"),
            _inputClass = Some("textarea--fullwidth"),
            _id = Some("report-action-new"),
            _rows = Some(5),
            _maxlength = Some(255),
            _dataProperties = Map(
                "data-rule-required" -> "true",
                "data-msg-required" -> messages("error.common.problem_report.action_mandatory.b")
            ),
            _hint = if(appConfig.hasFeature(GetHelpWithThisPageFeatureFieldHints, service)) {
                Some(messages("problem_report.action.hint.b"))
            } else {
                None
            },
            _bottomHint = Some(messages("problem_report.common.size_limit", 1000)),
            _clientSideValidation = clientSideValidation
            )

            @error_feedback_textarea(
            problemReportForm("report-error"),
            _label = Some(messages("problem_report.error.b")),
            _divClass = Some("form-field"),
            _inputClass = Some("textarea--fullwidth"),
            _id = Some("report-error-new"),
            _rows = Some(5),
            _maxlength = Some(255),
            _dataProperties = Map(
                "data-rule-required" -> "true",
                "data-msg-required" -> messages("error.common.problem_report.error_mandatory.b")
            ),
            _hint = if(appConfig.hasFeature(GetHelpWithThisPageFeatureFieldHints, service)) {
                Some(messages("problem_report.error.hint.b"))
            } else {
                None
            },
            _bottomHint = Some(messages("problem_report.common.size_limit", 1000)),
            _clientSideValidation = clientSideValidation
            )

            <input type="hidden" name="isJavascript" id="isJavascript" value="@problemReportForm.data.get("isJavascript")">
            @if(referrer.isDefined) {
            <input type="hidden" name="referrer" id="referrer" value="@referrer">
            }
            <input type="hidden" name="abFeatures" value="@{appConfig.getFeatures(service).map(_.name).mkString(";")}"/>

            <div class="form-field">
                <button id="report-submit" class="button" type="submit" data-journey-click="page:Click:Get help with this page Submit">@messages("form.send")</button>
            </div>
        </div>

    } else {

        <fieldset id="smallInputFields">
            <legend class="visuallyhidden">@messages("common.feedback.title")</legend>
            @error_feedback_input(
            problemReportForm("report-name"),
            _label = Some(messages("form.name")),
            _divClass = Some("form-group-compound"),
            _inputClass = Some("input--fullwidth form-control"),
            _id = Some("report-name"),
            _maxlength = Some(70),
            _dataProperties = Map(
                "data-rule-pattern" -> {
                    if(improvedNameFieldValidation) {
                        controllers.ProblemReportForm.REPORT_NAME_REGEX
                    } else {
                        controllers.ProblemReportForm.OLD_REPORT_NAME_REGEX
                    }
                },
                "data-msg-pattern" -> {
                    if (improvedNameFieldValidation) {
                        messages("error.common.problem_report.name_valid.b")
                    } else {
                        messages("error.common.problem_report.name_valid")
                    }
                },
                "data-rule-required" -> "true",
                "data-msg-required" -> messages("error.common.problem_report.name_mandatory")
            ),
            _clientSideValidation = clientSideValidation
            )

            @error_feedback_input(
            problemReportForm("report-email"),
            _label = Some(messages("problem_report.email")),
            _divClass = Some("form-group-compound"),
            _inputClass = Some("input--fullwidth form-control"),
            _id = Some("report-email"),
            _maxlength = Some(255),
            _dataProperties = Map(
                "data-rule-email" -> "true",
                "data-msg-email" -> messages("error.common.problem_report.email_valid"),
                "data-rule-required" -> "true",
                "data-msg-required" -> messages("error.common.problem_report.email_mandatory")
            ),
            _clientSideValidation = clientSideValidation
            )

            @error_feedback_input(
            problemReportForm("report-action"),
            _label = Some(messages("problem_report.action")),
            _divClass = Some("form-group-compound"),
            _inputClass = Some("input--fullwidth form-control"),
            _id = Some("report-action"),
            _maxlength = Some(1000),
            _dataProperties = Map(
                "data-rule-required" -> "true",
                "data-msg-required" -> messages("error.common.problem_report.action_mandatory")
            ),
            _clientSideValidation = clientSideValidation
            )

            @error_feedback_input(
            problemReportForm("report-error"),
            _label = Some(messages("problem_report.error")),
            _divClass = Some("form-group-compound"),
            _inputClass = Some("input--cleared form-control"),
            _id = Some("report-error"),
            _maxlength = Some(1000),
            _dataProperties = Map(
                "data-rule-required" -> "true",
                "data-msg-required" -> messages("error.common.problem_report.error_mandatory")
            ),
            _clientSideValidation = clientSideValidation
            )

            <input type="hidden" name="isJavascript" id="isJavascript" value="@problemReportForm.data.get("isJavascript")">
            @if(referrer.isDefined) {
                <input type="hidden" name="referrer" id="referrer" value="@referrer">
            }
            <input type="hidden" name="abFeatures" value="@{appConfig.getFeatures(service).map(_.name).mkString(";")}"/>

            <div class="form-field">
                <button id="report-submit" class="button" type="submit" data-journey-click="page:Click:Get help with this page Submit">@messages("form.send")</button>
            </div>
        </fieldset>
    }

</form>
